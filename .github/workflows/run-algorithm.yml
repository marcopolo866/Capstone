name: Run Algorithm

on:
  workflow_dispatch:
    inputs:
      algorithm:
        description: 'Algorithm to run'
        required: true
        type: choice
        options:
          - dijkstra
          - glasgow
          - vf3
      iterations:
        description: 'Number of benchmark iterations'
        required: false
        type: string
        default: '1'
      input_files:
        description: 'Comma-separated input file paths'
        required: true
        type: string
      request_id:
        description: 'Client request identifier'
        required: false
        type: string
  repository_dispatch:
    types:
      - run-algorithm

jobs:
  run-algorithm:
    runs-on: ubuntu-latest
    env:
      ALGORITHM_INPUT: ${{ github.event.inputs.algorithm || github.event.client_payload.algorithm }}
      ITERATIONS_INPUT: ${{ github.event.inputs.iterations || github.event.client_payload.iterations }}
      INPUT_FILES_INPUT: ${{ github.event.inputs.input_files || github.event.client_payload.input_files }}
      REQUEST_ID_INPUT: ${{ github.event.inputs.request_id || github.event.client_payload.request_id }}

    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download prebuilt binaries
        id: binaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          mkdir -p outputs
          : > outputs/binaries_download_error.txt
          set +e
          output="$(python - <<'PY'
          import json
          import os
          import stat
          import subprocess
          import urllib.parse
          import urllib.request
          import zipfile
          from pathlib import Path

          repo = os.environ.get("REPO")
          branch = os.environ.get("BRANCH") or "main"
          token = os.environ.get("GITHUB_TOKEN")
          workflow_file = "build-binaries.yml"
          artifact_name = "algorithm-binaries-linux"

          if not repo:
              raise SystemExit("REPO env var is missing")
          if not token:
              raise SystemExit("GITHUB_TOKEN env var is missing")

          api_base = f"https://api.github.com/repos/{repo}"
          headers = {
              "Accept": "application/vnd.github+json",
              "Authorization": f"Bearer {token}",
              "X-GitHub-Api-Version": "2022-11-28",
              "User-Agent": "capstone-download-binaries",
          }


          def api_get(path: str):
              url = api_base + path
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req) as resp:
                  return json.load(resp)


          query = urllib.parse.urlencode({"branch": branch, "status": "success", "per_page": 1})
          runs = api_get(f"/actions/workflows/{workflow_file}/runs?{query}")
          workflow_runs = runs.get("workflow_runs") or []
          if not workflow_runs:
              raise SystemExit(
                  f"No successful '{workflow_file}' runs found for branch '{branch}'. "
                  "Run the 'Build Binaries' workflow first."
              )

          run_id = workflow_runs[0].get("id")
          if not run_id:
              raise SystemExit("Could not read run_id from workflow_runs response.")

          artifacts = api_get(f"/actions/runs/{run_id}/artifacts")
          items = artifacts.get("artifacts") or []
          artifact = next(
              (a for a in items if a.get("name") == artifact_name and not a.get("expired")), None
          )
          if not artifact:
              available = ", ".join(sorted({a.get("name", "") for a in items if a.get("name")}))
              raise SystemExit(
                  f"Artifact '{artifact_name}' not found on run {run_id}. "
                  f"Available artifacts: {available or '(none)'}"
              )

          artifact_id = artifact.get("id")
          if not artifact_id:
              raise SystemExit("Could not read artifact id.")

          zip_path = Path("binaries.zip")
          download_url = f"{api_base}/actions/artifacts/{artifact_id}/zip"
          subprocess.run(
              [
                  "curl",
                  "-fsSL",
                  "-o",
                  str(zip_path),
                  "-H",
                  f"Authorization: Bearer {token}",
                  "-H",
                  "Accept: application/vnd.github+json",
                  download_url,
              ],
              check=True,
          )

          with zipfile.ZipFile(zip_path, "r") as zf:
              zf.extractall(".")

          expected = [
              "baselines/dijkstra",
              "src/dijkstra_llm",
              "src/vf3",
              "src/chatvf3",
              "baselines/vf3lib/bin/vf3",
              "baselines/glasgow-subgraph-solver/build/glasgow_subgraph_solver",
          ]

          missing = []
          for rel in expected:
              p = Path(rel)
              if not p.exists():
                  missing.append(rel)
                  continue
              mode = p.stat().st_mode
              p.chmod(mode | stat.S_IXUSR | stat.S_IXGRP | stat.S_IXOTH)

          if missing:
              raise SystemExit(
                  f"Missing expected binaries after extraction: {', '.join(missing)}"
              )

          print(f"Downloaded artifacts from run {run_id} (artifact_id={artifact_id}).")
          PY
          )"
          status=$?
          set -e
          if [ $status -eq 0 ]; then
            echo "READY=1" >> "$GITHUB_OUTPUT"
          else
            echo "READY=0" >> "$GITHUB_OUTPUT"
            echo "$output" > outputs/binaries_download_error.txt
            echo "$output"
          fi
          exit 0

      - name: Run algorithm
        id: run
        run: |
          set -uo pipefail
          ALGORITHM="${ALGORITHM_INPUT:-}"
          ITERATIONS_RAW="${ITERATIONS_INPUT:-1}"
          INPUT_FILES="${INPUT_FILES_INPUT:-}"
          REQUEST_ID="${REQUEST_ID_INPUT:-}"

          mkdir -p outputs
          : > outputs/result.txt

          if [ "${{ steps.binaries.outputs.READY }}" != "1" ]; then
            echo "Failed to download prebuilt binaries." >> outputs/result.txt
            if [ -s outputs/binaries_download_error.txt ]; then
              cat outputs/binaries_download_error.txt >> outputs/result.txt
            fi
            echo "EXIT_CODE=1" >> "$GITHUB_OUTPUT"
            echo "REQUEST_ID=${REQUEST_ID}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Parse input files
          IFS=',' read -ra FILES <<< "$INPUT_FILES"

          if [ "$ALGORITHM" = "dijkstra" ] && [ ${#FILES[@]} -lt 1 ]; then
            echo "No input file provided for Dijkstra." >> outputs/result.txt
            echo "EXIT_CODE=1" >> "$GITHUB_OUTPUT"
            echo "REQUEST_ID=${REQUEST_ID}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "$ALGORITHM" != "dijkstra" ] && [ ${#FILES[@]} -lt 2 ]; then
            echo "Pattern/target files are required for $ALGORITHM." >> outputs/result.txt
            echo "EXIT_CODE=1" >> "$GITHUB_OUTPUT"
            echo "REQUEST_ID=${REQUEST_ID}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ITERATIONS="1"
          if [[ "$ITERATIONS_RAW" =~ ^[0-9]+$ ]] && [ "$ITERATIONS_RAW" -ge 1 ]; then
            ITERATIONS="$ITERATIONS_RAW"
          fi
          if [ "$ITERATIONS" -gt 1000 ]; then
            ITERATIONS="1000"
          fi

          run_capture() {
            local _out_var=$1
            local _dur_var=$2
            shift 2
            local tmp
            tmp=$(mktemp)
            local start_ns end_ns duration_ms
            start_ns=$(date +%s%N)
            set +e
            "$@" >"$tmp" 2>&1
            local status=$?
            set -e
            end_ns=$(date +%s%N)
            duration_ms=$(python - <<'PY' "$start_ns" "$end_ns"
          import sys
          start=int(sys.argv[1]); end=int(sys.argv[2])
          print(f"{(end - start)/1_000_000:.3f}")
          PY
            )
            printf -v "$_out_var" "%s" "$(cat "$tmp")"
            printf -v "$_dur_var" "%s" "$duration_ms"
            rm -f "$tmp"
            return $status
          }

          bench_capture_n() {
            local _out_var=$1
            local _times_var=$2
            local _runs=$3
            shift 3

            local out dur
            local -a times
            local out_first=""

            for ((i=1; i<=_runs; i++)); do
              if ! run_capture out dur "$@"; then
                printf -v "$_out_var" "%s" "$out"
                return 1
              fi
              if [ $i -eq 1 ]; then
                out_first="$out"
              fi
              times+=("$dur")
            done

            printf -v "$_out_var" "%s" "$out_first"
            printf -v "$_times_var" "%s" "${times[*]}"
            return 0
          }

          run_capture_rss() {
            local _out_var=$1
            local _dur_var=$2
            local _rss_var=$3
            shift 3
            local tmp rss_tmp
            tmp=$(mktemp)
            rss_tmp=$(mktemp)
            local start_ns end_ns duration_ms rss_kb
            start_ns=$(date +%s%N)
            set +e
            if [ -x /usr/bin/time ]; then
              /usr/bin/time -f "%M" -o "$rss_tmp" "$@" >"$tmp" 2>&1
            else
              "$@" >"$tmp" 2>&1
            fi
            local status=$?
            set -e
            end_ns=$(date +%s%N)
            duration_ms=$(python - <<'PY' "$start_ns" "$end_ns"
          import sys
          start=int(sys.argv[1]); end=int(sys.argv[2])
          print(f"{(end - start)/1_000_000:.3f}")
          PY
            )
            rss_kb=""
            if [ -s "$rss_tmp" ]; then
              rss_kb="$(head -n1 "$rss_tmp" | tr -d '\r' | awk '{print $1}')"
            fi
            printf -v "$_out_var" "%s" "$(cat "$tmp")"
            printf -v "$_dur_var" "%s" "$duration_ms"
            printf -v "$_rss_var" "%s" "$rss_kb"
            rm -f "$tmp" "$rss_tmp"
            return $status
          }

          bench_capture_rss_n() {
            local _out_var=$1
            local _times_var=$2
            local _rss_var=$3
            local _runs=$4
            shift 4

            local out dur rss
            local -a times rsses
            local out_first=""

            for ((i=1; i<=_runs; i++)); do
              if ! run_capture_rss out dur rss "$@"; then
                printf -v "$_out_var" "%s" "$out"
                return 1
              fi
              if [ $i -eq 1 ]; then
                out_first="$out"
              fi
              times+=("$dur")
              rsses+=("$rss")
            done

            printf -v "$_out_var" "%s" "$out_first"
            printf -v "$_times_var" "%s" "${times[*]}"
            printf -v "$_rss_var" "%s" "${rsses[*]}"
            return 0
          }

          calc_stats_ms() {
            python - <<'PY' "$@"
          import statistics
          import sys

          vals = []
          for x in sys.argv[1:]:
              try:
                  vals.append(float(x))
              except ValueError:
                  pass

          if not vals:
              print("")
              raise SystemExit(0)

          n = len(vals)
          mean = statistics.fmean(vals)
          median = statistics.median(vals)
          stdev = statistics.stdev(vals) if n > 1 else 0.0
          print(
              f"{median:.3f} {mean:.3f} {stdev:.3f} {min(vals):.3f} {max(vals):.3f} {n}"
          )
          PY
          }

          calc_stats_kb() {
            python - <<'PY' "$@"
          import statistics
          import sys

          vals = []
          for x in sys.argv[1:]:
              try:
                  vals.append(int(x))
              except ValueError:
                  pass

          if not vals:
              print("")
              raise SystemExit(0)

          n = len(vals)
          mean = statistics.fmean(vals)
          median = statistics.median_low(vals)
          stdev = statistics.stdev(vals) if n > 1 else 0.0
          print(
              f"{median} {int(round(mean))} {int(round(stdev))} {min(vals)} {max(vals)} {n}"
          )
          PY
          }

          print_stats_ms_first_all() {
            local prefix="$1"
            shift
            local indent
            indent="$(printf '%*s' ${#prefix} '')"
            printf "%s%-5s median=%10.3f mean=%10.3f stdev=%10.3f min=%10.3f max=%10.3f\n" \
              "$prefix" "first" "$1" "$2" "$3" "$4" "$5"
            printf "%s%-5s median=%10.3f mean=%10.3f stdev=%10.3f min=%10.3f max=%10.3f\n" \
              "$indent" "all" "$6" "$7" "$8" "$9" "${10}"
          }

          print_stats_kb_first_all() {
            local prefix="$1"
            shift
            local indent
            indent="$(printf '%*s' ${#prefix} '')"
            printf "%s%-5s median=%10d mean=%10d stdev=%10d min=%10d max=%10d\n" \
              "$prefix" "first" "$1" "$2" "$3" "$4" "$5"
            printf "%s%-5s median=%10d mean=%10d stdev=%10d min=%10d max=%10d\n" \
              "$indent" "all" "$6" "$7" "$8" "$9" "${10}"
          }

          EXIT_CODE=0

          case "$ALGORITHM" in
            dijkstra)
              dijkstra_baseline_out=""
              dijkstra_baseline_ms_runs=""
              dijkstra_llm_out=""
              dijkstra_llm_ms_runs=""

              if ! bench_capture_n dijkstra_baseline_out dijkstra_baseline_ms_runs "$ITERATIONS" ./baselines/dijkstra "${FILES[0]}"; then
                EXIT_CODE=1
                echo "[Dijkstra Baseline] failed to run." >> outputs/result.txt
              else
                read dijkstra_baseline_ms_median dijkstra_baseline_ms_mean dijkstra_baseline_ms_stdev dijkstra_baseline_ms_min dijkstra_baseline_ms_max dijkstra_baseline_ms_n <<< "$(calc_stats_ms $dijkstra_baseline_ms_runs)"
                dijkstra_baseline_ms="$dijkstra_baseline_ms_median"
                {
                  echo "[Dijkstra Baseline]"
                  echo "$dijkstra_baseline_out"
                  echo "Iterations: $ITERATIONS"
                  if [ -n "${dijkstra_baseline_ms_median:-}" ]; then
                    echo "Runtime (ms): median=$dijkstra_baseline_ms_median mean=$dijkstra_baseline_ms_mean stdev=$dijkstra_baseline_ms_stdev min=$dijkstra_baseline_ms_min max=$dijkstra_baseline_ms_max"
                  fi
                  echo
                } >> outputs/result.txt
              fi
              if ! bench_capture_n dijkstra_llm_out dijkstra_llm_ms_runs "$ITERATIONS" ./src/dijkstra_llm "${FILES[0]}"; then
                EXIT_CODE=1
                echo "[Dijkstra LLM] failed to run." >> outputs/result.txt
              else
                read dijkstra_llm_ms_median dijkstra_llm_ms_mean dijkstra_llm_ms_stdev dijkstra_llm_ms_min dijkstra_llm_ms_max dijkstra_llm_ms_n <<< "$(calc_stats_ms $dijkstra_llm_ms_runs)"
                dijkstra_llm_ms="$dijkstra_llm_ms_median"
                {
                  echo "[Dijkstra LLM]"
                  echo "$dijkstra_llm_out"
                  echo "Iterations: $ITERATIONS"
                  if [ -n "${dijkstra_llm_ms_median:-}" ]; then
                    echo "Runtime (ms): median=$dijkstra_llm_ms_median mean=$dijkstra_llm_ms_mean stdev=$dijkstra_llm_ms_stdev min=$dijkstra_llm_ms_min max=$dijkstra_llm_ms_max"
                  fi
                  echo
                } >> outputs/result.txt
              fi
              ;;
            glasgow)
              glasgow_first_out=""
              glasgow_first_ms_runs=""
              glasgow_first_rss_runs=""
              glasgow_all_out=""
              glasgow_all_ms_runs=""
              glasgow_all_rss_runs=""

              if ! bench_capture_rss_n glasgow_first_out glasgow_first_ms_runs glasgow_first_rss_runs "$ITERATIONS" ./baselines/glasgow-subgraph-solver/build/glasgow_subgraph_solver --format lad "${FILES[0]}" "${FILES[1]}"; then
                EXIT_CODE=1
                echo "[Glasgow Subgraph Solver] first-solution run failed." >> outputs/result.txt
              fi
              if ! bench_capture_rss_n glasgow_all_out glasgow_all_ms_runs glasgow_all_rss_runs "$ITERATIONS" ./baselines/glasgow-subgraph-solver/build/glasgow_subgraph_solver --count-solutions --format lad "${FILES[0]}" "${FILES[1]}"; then
                EXIT_CODE=1
                echo "[Glasgow Subgraph Solver] all-solutions run failed." >> outputs/result.txt
              fi

              if [ -n "${glasgow_first_ms_runs:-}" ]; then
                read glasgow_first_ms_median glasgow_first_ms_mean glasgow_first_ms_stdev glasgow_first_ms_min glasgow_first_ms_max glasgow_first_ms_n <<< "$(calc_stats_ms $glasgow_first_ms_runs)"
                glasgow_first_ms="$glasgow_first_ms_median"
              fi
              if [ -n "${glasgow_all_ms_runs:-}" ]; then
                read glasgow_all_ms_median glasgow_all_ms_mean glasgow_all_ms_stdev glasgow_all_ms_min glasgow_all_ms_max glasgow_all_ms_n <<< "$(calc_stats_ms $glasgow_all_ms_runs)"
                glasgow_all_ms="$glasgow_all_ms_median"
              fi
              if [ -n "${glasgow_first_rss_runs:-}" ]; then
                read glasgow_first_rss_median glasgow_first_rss_mean glasgow_first_rss_stdev glasgow_first_rss_min glasgow_first_rss_max glasgow_first_rss_n <<< "$(calc_stats_kb $glasgow_first_rss_runs)"
                glasgow_first_rss_kb="$glasgow_first_rss_median"
              fi
              if [ -n "${glasgow_all_rss_runs:-}" ]; then
                read glasgow_all_rss_median glasgow_all_rss_mean glasgow_all_rss_stdev glasgow_all_rss_min glasgow_all_rss_max glasgow_all_rss_n <<< "$(calc_stats_kb $glasgow_all_rss_runs)"
                glasgow_all_rss_kb="$glasgow_all_rss_median"
              fi
              if [ -n "${glasgow_all_out:-}" ]; then
                {
                  echo "[Glasgow Subgraph Solver]"
                  echo "$glasgow_all_out"
                  echo "Iterations: $ITERATIONS"
                  if [ -n "${glasgow_first_ms_median:-}" ] && [ -n "${glasgow_all_ms_median:-}" ]; then
                    print_stats_ms_first_all "Runtime (ms): " \
                      "$glasgow_first_ms_median" "$glasgow_first_ms_mean" "$glasgow_first_ms_stdev" "$glasgow_first_ms_min" "$glasgow_first_ms_max" \
                      "$glasgow_all_ms_median" "$glasgow_all_ms_mean" "$glasgow_all_ms_stdev" "$glasgow_all_ms_min" "$glasgow_all_ms_max"
                  fi
                  if [ -n "${glasgow_first_rss_median:-}" ] && [ -n "${glasgow_all_rss_median:-}" ]; then
                    print_stats_kb_first_all "Max RSS (kB): " \
                      "$glasgow_first_rss_median" "$glasgow_first_rss_mean" "$glasgow_first_rss_stdev" "$glasgow_first_rss_min" "$glasgow_first_rss_max" \
                      "$glasgow_all_rss_median" "$glasgow_all_rss_mean" "$glasgow_all_rss_stdev" "$glasgow_all_rss_min" "$glasgow_all_rss_max"
                  fi
                  echo
                } >> outputs/result.txt
              fi
              ;;
            vf3)
              vf3_base_first_out=""
              vf3_base_first_ms_runs=""
              vf3_base_first_rss_runs=""
              vf3_base_all_out=""
              vf3_base_all_ms_runs=""
              vf3_base_all_rss_runs=""

              vf3_first_out=""
              vf3_first_ms_runs=""
              vf3_first_rss_runs=""
              vf3_all_out=""
              vf3_all_ms_runs=""
              vf3_all_rss_runs=""

              chatvf3_first_out=""
              chatvf3_first_ms_runs=""
              chatvf3_first_rss_runs=""
              chatvf3_all_out=""
              chatvf3_all_ms_runs=""
              chatvf3_all_rss_runs=""

              if ! bench_capture_rss_n vf3_base_first_out vf3_base_first_ms_runs vf3_base_first_rss_runs "$ITERATIONS" ./baselines/vf3lib/bin/vf3 -r 0 -F "${FILES[0]}" "${FILES[1]}"; then
                EXIT_CODE=1
                echo "[VF3 baseline] first-solution run failed." >> outputs/result.txt
              fi
              if ! bench_capture_rss_n vf3_base_all_out vf3_base_all_ms_runs vf3_base_all_rss_runs "$ITERATIONS" ./baselines/vf3lib/bin/vf3 -r 0 "${FILES[0]}" "${FILES[1]}"; then
                EXIT_CODE=1
                echo "[VF3 baseline] all-solutions run failed." >> outputs/result.txt
              fi

              if [ -n "${vf3_base_first_ms_runs:-}" ]; then
                read vf3_base_first_ms_median vf3_base_first_ms_mean vf3_base_first_ms_stdev vf3_base_first_ms_min vf3_base_first_ms_max vf3_base_first_ms_n <<< "$(calc_stats_ms $vf3_base_first_ms_runs)"
                vf3_base_first_ms="$vf3_base_first_ms_median"
              fi
              if [ -n "${vf3_base_all_ms_runs:-}" ]; then
                read vf3_base_all_ms_median vf3_base_all_ms_mean vf3_base_all_ms_stdev vf3_base_all_ms_min vf3_base_all_ms_max vf3_base_all_ms_n <<< "$(calc_stats_ms $vf3_base_all_ms_runs)"
                vf3_base_all_ms="$vf3_base_all_ms_median"
              fi
              if [ -n "${vf3_base_first_rss_runs:-}" ]; then
                read vf3_base_first_rss_median vf3_base_first_rss_mean vf3_base_first_rss_stdev vf3_base_first_rss_min vf3_base_first_rss_max vf3_base_first_rss_n <<< "$(calc_stats_kb $vf3_base_first_rss_runs)"
                vf3_base_first_rss_kb="$vf3_base_first_rss_median"
              fi
              if [ -n "${vf3_base_all_rss_runs:-}" ]; then
                read vf3_base_all_rss_median vf3_base_all_rss_mean vf3_base_all_rss_stdev vf3_base_all_rss_min vf3_base_all_rss_max vf3_base_all_rss_n <<< "$(calc_stats_kb $vf3_base_all_rss_runs)"
                vf3_base_all_rss_kb="$vf3_base_all_rss_median"
              fi
              if [ -n "${vf3_base_all_out:-}" ]; then
                vf3_base_result_line=$(echo "$vf3_base_all_out" | head -n1)
                vf3_base_result=$(echo "$vf3_base_result_line" | awk '{print $1}')
                if [ -z "$vf3_base_result" ]; then
                  vf3_base_result="$vf3_base_result_line"
                fi
                {
                  echo "[VF3 baseline]"
                  echo "$vf3_base_result"
                  echo "Iterations: $ITERATIONS"
                  if [ -n "${vf3_base_first_ms_median:-}" ] && [ -n "${vf3_base_all_ms_median:-}" ]; then
                    print_stats_ms_first_all "Runtime (ms): " \
                      "$vf3_base_first_ms_median" "$vf3_base_first_ms_mean" "$vf3_base_first_ms_stdev" "$vf3_base_first_ms_min" "$vf3_base_first_ms_max" \
                      "$vf3_base_all_ms_median" "$vf3_base_all_ms_mean" "$vf3_base_all_ms_stdev" "$vf3_base_all_ms_min" "$vf3_base_all_ms_max"
                  fi
                  if [ -n "${vf3_base_first_rss_median:-}" ] && [ -n "${vf3_base_all_rss_median:-}" ]; then
                    print_stats_kb_first_all "Max RSS (kB): " \
                      "$vf3_base_first_rss_median" "$vf3_base_first_rss_mean" "$vf3_base_first_rss_stdev" "$vf3_base_first_rss_min" "$vf3_base_first_rss_max" \
                      "$vf3_base_all_rss_median" "$vf3_base_all_rss_mean" "$vf3_base_all_rss_stdev" "$vf3_base_all_rss_min" "$vf3_base_all_rss_max"
                  fi
                  echo
                } >> outputs/result.txt
              fi

              if ! bench_capture_rss_n vf3_first_out vf3_first_ms_runs vf3_first_rss_runs "$ITERATIONS" ./src/vf3 --first-only "${FILES[0]}" "${FILES[1]}"; then
                EXIT_CODE=1
                echo "[VF3 Gemini] first-solution run failed." >> outputs/result.txt
              fi
              if ! bench_capture_rss_n vf3_all_out vf3_all_ms_runs vf3_all_rss_runs "$ITERATIONS" ./src/vf3 "${FILES[0]}" "${FILES[1]}"; then
                EXIT_CODE=1
                echo "[VF3 Gemini] all-solutions run failed." >> outputs/result.txt
              fi

              if [ -n "${vf3_first_ms_runs:-}" ]; then
                read vf3_first_ms_median vf3_first_ms_mean vf3_first_ms_stdev vf3_first_ms_min vf3_first_ms_max vf3_first_ms_n <<< "$(calc_stats_ms $vf3_first_ms_runs)"
                vf3_first_ms="$vf3_first_ms_median"
              fi
              if [ -n "${vf3_all_ms_runs:-}" ]; then
                read vf3_all_ms_median vf3_all_ms_mean vf3_all_ms_stdev vf3_all_ms_min vf3_all_ms_max vf3_all_ms_n <<< "$(calc_stats_ms $vf3_all_ms_runs)"
                vf3_all_ms="$vf3_all_ms_median"
              fi
              if [ -n "${vf3_first_rss_runs:-}" ]; then
                read vf3_first_rss_median vf3_first_rss_mean vf3_first_rss_stdev vf3_first_rss_min vf3_first_rss_max vf3_first_rss_n <<< "$(calc_stats_kb $vf3_first_rss_runs)"
                vf3_first_rss_kb="$vf3_first_rss_median"
              fi
              if [ -n "${vf3_all_rss_runs:-}" ]; then
                read vf3_all_rss_median vf3_all_rss_mean vf3_all_rss_stdev vf3_all_rss_min vf3_all_rss_max vf3_all_rss_n <<< "$(calc_stats_kb $vf3_all_rss_runs)"
                vf3_all_rss_kb="$vf3_all_rss_median"
              fi
              if [ -n "${vf3_all_out:-}" ]; then
                vf3_gemini_result="$(echo "$vf3_all_out" | head -n1)"
                {
                  echo "[VF3 Gemini]"
                  echo "$vf3_gemini_result"
                  echo "Iterations: $ITERATIONS"
                  if [ -n "${vf3_first_ms_median:-}" ] && [ -n "${vf3_all_ms_median:-}" ]; then
                    print_stats_ms_first_all "Runtime (ms): " \
                      "$vf3_first_ms_median" "$vf3_first_ms_mean" "$vf3_first_ms_stdev" "$vf3_first_ms_min" "$vf3_first_ms_max" \
                      "$vf3_all_ms_median" "$vf3_all_ms_mean" "$vf3_all_ms_stdev" "$vf3_all_ms_min" "$vf3_all_ms_max"
                  fi
                  if [ -n "${vf3_first_rss_median:-}" ] && [ -n "${vf3_all_rss_median:-}" ]; then
                    print_stats_kb_first_all "Max RSS (kB): " \
                      "$vf3_first_rss_median" "$vf3_first_rss_mean" "$vf3_first_rss_stdev" "$vf3_first_rss_min" "$vf3_first_rss_max" \
                      "$vf3_all_rss_median" "$vf3_all_rss_mean" "$vf3_all_rss_stdev" "$vf3_all_rss_min" "$vf3_all_rss_max"
                  fi
                  echo
                } >> outputs/result.txt
              fi

              if ! bench_capture_rss_n chatvf3_first_out chatvf3_first_ms_runs chatvf3_first_rss_runs "$ITERATIONS" ./src/chatvf3 --first-only "${FILES[0]}" "${FILES[1]}"; then
                EXIT_CODE=1
                echo "[VF3 ChatGPT] first-solution run failed." >> outputs/result.txt
              fi
              if ! bench_capture_rss_n chatvf3_all_out chatvf3_all_ms_runs chatvf3_all_rss_runs "$ITERATIONS" ./src/chatvf3 "${FILES[0]}" "${FILES[1]}"; then
                EXIT_CODE=1
                echo "[VF3 ChatGPT] all-solutions run failed." >> outputs/result.txt
              fi

              if [ -n "${chatvf3_first_ms_runs:-}" ]; then
                read chatvf3_first_ms_median chatvf3_first_ms_mean chatvf3_first_ms_stdev chatvf3_first_ms_min chatvf3_first_ms_max chatvf3_first_ms_n <<< "$(calc_stats_ms $chatvf3_first_ms_runs)"
                chatvf3_first_ms="$chatvf3_first_ms_median"
              fi
              if [ -n "${chatvf3_all_ms_runs:-}" ]; then
                read chatvf3_all_ms_median chatvf3_all_ms_mean chatvf3_all_ms_stdev chatvf3_all_ms_min chatvf3_all_ms_max chatvf3_all_ms_n <<< "$(calc_stats_ms $chatvf3_all_ms_runs)"
                chatvf3_all_ms="$chatvf3_all_ms_median"
              fi
              if [ -n "${chatvf3_first_rss_runs:-}" ]; then
                read chatvf3_first_rss_median chatvf3_first_rss_mean chatvf3_first_rss_stdev chatvf3_first_rss_min chatvf3_first_rss_max chatvf3_first_rss_n <<< "$(calc_stats_kb $chatvf3_first_rss_runs)"
                chatvf3_first_rss_kb="$chatvf3_first_rss_median"
              fi
              if [ -n "${chatvf3_all_rss_runs:-}" ]; then
                read chatvf3_all_rss_median chatvf3_all_rss_mean chatvf3_all_rss_stdev chatvf3_all_rss_min chatvf3_all_rss_max chatvf3_all_rss_n <<< "$(calc_stats_kb $chatvf3_all_rss_runs)"
                chatvf3_all_rss_kb="$chatvf3_all_rss_median"
              fi
              if [ -n "${chatvf3_all_out:-}" ]; then
                chatvf3_result="$(echo "$chatvf3_all_out" | head -n1)"
                {
                  echo "[VF3 ChatGPT]"
                  echo "$chatvf3_result"
                  echo "Iterations: $ITERATIONS"
                  if [ -n "${chatvf3_first_ms_median:-}" ] && [ -n "${chatvf3_all_ms_median:-}" ]; then
                    print_stats_ms_first_all "Runtime (ms): " \
                      "$chatvf3_first_ms_median" "$chatvf3_first_ms_mean" "$chatvf3_first_ms_stdev" "$chatvf3_first_ms_min" "$chatvf3_first_ms_max" \
                      "$chatvf3_all_ms_median" "$chatvf3_all_ms_mean" "$chatvf3_all_ms_stdev" "$chatvf3_all_ms_min" "$chatvf3_all_ms_max"
                  fi
                  if [ -n "${chatvf3_first_rss_median:-}" ] && [ -n "${chatvf3_all_rss_median:-}" ]; then
                    print_stats_kb_first_all "Max RSS (kB): " \
                      "$chatvf3_first_rss_median" "$chatvf3_first_rss_mean" "$chatvf3_first_rss_stdev" "$chatvf3_first_rss_min" "$chatvf3_first_rss_max" \
                      "$chatvf3_all_rss_median" "$chatvf3_all_rss_mean" "$chatvf3_all_rss_stdev" "$chatvf3_all_rss_min" "$chatvf3_all_rss_max"
                  fi
                  echo
                } >> outputs/result.txt
              fi
              ;;
            *)
              echo "Unknown algorithm: $ALGORITHM" >> outputs/result.txt
              EXIT_CODE=1
              ;;
          esac
          
          echo "EXIT_CODE=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          echo "REQUEST_ID=${REQUEST_ID}" >> "$GITHUB_OUTPUT"
          echo "ITERATIONS=${ITERATIONS}" >> "$GITHUB_OUTPUT"
          echo "DIJKSTRA_BASELINE_MS=${dijkstra_baseline_ms:-}" >> "$GITHUB_OUTPUT"
          echo "DIJKSTRA_LLM_MS=${dijkstra_llm_ms:-}" >> "$GITHUB_OUTPUT"
          echo "GLASGOW_FIRST_MS=${glasgow_first_ms:-}" >> "$GITHUB_OUTPUT"
          echo "GLASGOW_ALL_MS=${glasgow_all_ms:-}" >> "$GITHUB_OUTPUT"
          echo "GLASGOW_FIRST_RSS_KB=${glasgow_first_rss_kb:-}" >> "$GITHUB_OUTPUT"
          echo "GLASGOW_ALL_RSS_KB=${glasgow_all_rss_kb:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_BASE_FIRST_MS=${vf3_base_first_ms:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_BASE_ALL_MS=${vf3_base_all_ms:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_BASE_FIRST_RSS_KB=${vf3_base_first_rss_kb:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_BASE_ALL_RSS_KB=${vf3_base_all_rss_kb:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_GEMINI_FIRST_MS=${vf3_first_ms:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_GEMINI_ALL_MS=${vf3_all_ms:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_GEMINI_FIRST_RSS_KB=${vf3_first_rss_kb:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_GEMINI_ALL_RSS_KB=${vf3_all_rss_kb:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_CHATGPT_FIRST_MS=${chatvf3_first_ms:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_CHATGPT_ALL_MS=${chatvf3_all_ms:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_CHATGPT_FIRST_RSS_KB=${chatvf3_first_rss_kb:-}" >> "$GITHUB_OUTPUT"
          echo "VF3_CHATGPT_ALL_RSS_KB=${chatvf3_all_rss_kb:-}" >> "$GITHUB_OUTPUT"
          # Always exit 0 so later steps run and results are committed
          exit 0
      
      - name: Create result JSON
        if: always()
        env:
          EXIT_CODE: ${{ steps.run.outputs.EXIT_CODE }}
          ITERATIONS: ${{ steps.run.outputs.ITERATIONS }}
          DIJKSTRA_BASELINE_MS: ${{ steps.run.outputs.DIJKSTRA_BASELINE_MS }}
          DIJKSTRA_LLM_MS: ${{ steps.run.outputs.DIJKSTRA_LLM_MS }}
          GLASGOW_FIRST_MS: ${{ steps.run.outputs.GLASGOW_FIRST_MS }}
          GLASGOW_ALL_MS: ${{ steps.run.outputs.GLASGOW_ALL_MS }}
          GLASGOW_FIRST_RSS_KB: ${{ steps.run.outputs.GLASGOW_FIRST_RSS_KB }}
          GLASGOW_ALL_RSS_KB: ${{ steps.run.outputs.GLASGOW_ALL_RSS_KB }}
          VF3_BASE_FIRST_MS: ${{ steps.run.outputs.VF3_BASE_FIRST_MS }}
          VF3_BASE_ALL_MS: ${{ steps.run.outputs.VF3_BASE_ALL_MS }}
          VF3_BASE_FIRST_RSS_KB: ${{ steps.run.outputs.VF3_BASE_FIRST_RSS_KB }}
          VF3_BASE_ALL_RSS_KB: ${{ steps.run.outputs.VF3_BASE_ALL_RSS_KB }}
          VF3_GEMINI_FIRST_MS: ${{ steps.run.outputs.VF3_GEMINI_FIRST_MS }}
          VF3_GEMINI_ALL_MS: ${{ steps.run.outputs.VF3_GEMINI_ALL_MS }}
          VF3_GEMINI_FIRST_RSS_KB: ${{ steps.run.outputs.VF3_GEMINI_FIRST_RSS_KB }}
          VF3_GEMINI_ALL_RSS_KB: ${{ steps.run.outputs.VF3_GEMINI_ALL_RSS_KB }}
          VF3_CHATGPT_FIRST_MS: ${{ steps.run.outputs.VF3_CHATGPT_FIRST_MS }}
          VF3_CHATGPT_ALL_MS: ${{ steps.run.outputs.VF3_CHATGPT_ALL_MS }}
          VF3_CHATGPT_FIRST_RSS_KB: ${{ steps.run.outputs.VF3_CHATGPT_FIRST_RSS_KB }}
          VF3_CHATGPT_ALL_RSS_KB: ${{ steps.run.outputs.VF3_CHATGPT_ALL_RSS_KB }}
        run: |
          python - <<'PY'
          import datetime
          import json
          import os
          from pathlib import Path

          algorithm = os.environ.get("ALGORITHM_INPUT", "")
          exit_code = os.environ.get("EXIT_CODE", "")
          request_id = os.environ.get("REQUEST_ID_INPUT", "")
          timestamp = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")

          result_txt = Path("outputs/result.txt")
          text = ""
          if result_txt.exists():
              text = result_txt.read_text(encoding="utf-8", errors="replace")

          if exit_code == "0":
              status = "success"
              output = text or "No output"
              error = ""
          else:
              status = "error"
              output = ""
              error = text or "Unknown error"

          Path("outputs").mkdir(parents=True, exist_ok=True)
          data = {
              "algorithm": algorithm,
              "timestamp": timestamp,
              "status": status,
              "output": output,
              "error": error,
              "request_id": request_id,
          }
          iterations = os.environ.get("ITERATIONS", "").strip()
          if iterations:
              try:
                  data["iterations"] = int(iterations)
              except ValueError:
                  pass
          timings_ms = {}
          if algorithm == "dijkstra":
              baseline = os.environ.get("DIJKSTRA_BASELINE_MS", "")
              llm = os.environ.get("DIJKSTRA_LLM_MS", "")
              if baseline:
                  timings_ms["baseline"] = float(baseline)
              if llm:
                  timings_ms["llm"] = float(llm)
          elif algorithm == "glasgow":
              first = os.environ.get("GLASGOW_FIRST_MS", "")
              all_ms = os.environ.get("GLASGOW_ALL_MS", "")
              if first:
                  timings_ms["first"] = float(first)
              if all_ms:
                  timings_ms["all"] = float(all_ms)
          elif algorithm == "vf3":
              def maybe_add(name: str, key: str) -> None:
                  value = os.environ.get(key, "")
                  if value:
                      timings_ms[name] = float(value)

              maybe_add("baseline_first", "VF3_BASE_FIRST_MS")
              maybe_add("baseline_all", "VF3_BASE_ALL_MS")
              maybe_add("gemini_first", "VF3_GEMINI_FIRST_MS")
              maybe_add("gemini_all", "VF3_GEMINI_ALL_MS")
              maybe_add("chatgpt_first", "VF3_CHATGPT_FIRST_MS")
              maybe_add("chatgpt_all", "VF3_CHATGPT_ALL_MS")
          if timings_ms:
              data["timings_ms"] = timings_ms

          memory_kb = {}
          if algorithm == "glasgow":
              first = os.environ.get("GLASGOW_FIRST_RSS_KB", "")
              all_kb = os.environ.get("GLASGOW_ALL_RSS_KB", "")
              if first:
                  try:
                      memory_kb["first"] = int(first)
                  except ValueError:
                      pass
              if all_kb:
                  try:
                      memory_kb["all"] = int(all_kb)
                  except ValueError:
                      pass
          elif algorithm == "vf3":
              def maybe_add_int(name: str, key: str) -> None:
                  value = os.environ.get(key, "")
                  if not value:
                      return
                  try:
                      memory_kb[name] = int(value)
                  except ValueError:
                      return

              maybe_add_int("baseline_first", "VF3_BASE_FIRST_RSS_KB")
              maybe_add_int("baseline_all", "VF3_BASE_ALL_RSS_KB")
              maybe_add_int("gemini_first", "VF3_GEMINI_FIRST_RSS_KB")
              maybe_add_int("gemini_all", "VF3_GEMINI_ALL_RSS_KB")
              maybe_add_int("chatgpt_first", "VF3_CHATGPT_FIRST_RSS_KB")
              maybe_add_int("chatgpt_all", "VF3_CHATGPT_ALL_RSS_KB")

          if memory_kb:
              data["memory_kb"] = memory_kb
          Path("outputs/result.json").write_text(
              json.dumps(data, indent=2) + "\n", encoding="utf-8"
          )
          PY

      - name: Commit results
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add outputs/result.json
          git commit -m "Add algorithm results [skip ci]" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
