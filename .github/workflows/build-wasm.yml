name: Build WASM Modules

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - wasm/**

jobs:
  build-wasm:
    # Prevent infinite loops when this workflow commits WASM artifacts back to the repo.
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}
          submodules: recursive

      - name: Install Emscripten SDK
        run: |
          set -euo pipefail
          if [ ! -d emsdk ]; then
            git clone https://github.com/emscripten-core/emsdk.git emsdk
          fi
          cd emsdk
          ./emsdk install latest
          ./emsdk activate latest

      - name: Build VF3 WASM modules
        run: |
          set -euo pipefail
          source emsdk/emsdk_env.sh

          mkdir -p wasm

          echo "Patching vf3lib headers for Emscripten..."
          python3 - <<'PY'
          from pathlib import Path

          path = Path("baselines/vf3lib/include/VF3State.hpp")
          text = path.read_text(encoding="utf-8")
          old = "(int*)calloc(classes_count, sizeof(int))"
          new = "(uint32_t*)calloc(classes_count, sizeof(uint32_t))"
          count = text.count(old)
          if count == 0:
              raise SystemExit(f"Expected pattern not found in {path}")
          path.write_text(text.replace(old, new), encoding="utf-8")
          print(f"Patched {path} ({count} replacements)")
          PY

          common_flags=(
            -O3
            -DNDEBUG
            -s WASM=1
            -s MODULARIZE=1
            -s ENVIRONMENT=web
            -s ALLOW_MEMORY_GROWTH=1
            -s EXIT_RUNTIME=0
            -s FORCE_FILESYSTEM=1
            -s EXPORTED_RUNTIME_METHODS='["FS","callMain"]'
          )

          echo "Building VF3 baseline (vf3lib)..."
          em++ -std=c++11 \
            "${common_flags[@]}" \
            -I "baselines/vf3lib/include" \
            -DVF3 \
            "wasm/vf3_baseline_main.cpp" \
            -s EXPORT_NAME=createVf3BaselineModule \
            -o "wasm/vf3_baseline.js"

          echo "Building VF3 Gemini..."
          em++ -std=c++17 \
            "${common_flags[@]}" \
            -fexceptions \
            -s DISABLE_EXCEPTION_CATCHING=0 \
            "src/[GEMINI] Subgraph Isomorphism.cpp" \
            -s EXPORT_NAME=createVf3GeminiModule \
            -o "wasm/vf3_gemini.js"

          echo "Building VF3 ChatGPT..."
          em++ -std=c++17 \
            "${common_flags[@]}" \
            -fexceptions \
            -s DISABLE_EXCEPTION_CATCHING=0 \
            "src/[CHATGPT] Subgraph Isomorphism.cpp" \
            -s EXPORT_NAME=createVf3ChatgptModule \
            -o "wasm/vf3_chatgpt.js"

      - name: Commit updated WASM artifacts
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add wasm
          if git diff --cached --quiet; then
            echo "No WASM changes to commit."
            exit 0
          fi
          git commit -m "Update WASM modules"
          git push origin "HEAD:${GITHUB_REF_NAME}"
